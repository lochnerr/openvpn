#!/bin/sh

set -e

# Script to setup an easyrsa certificate authority for testing.

create_ca() {

  echo "Creating CA: $1"

  TARGET="$1"
  NAME="${2:-Test CA}"
  OPTS="$3"

  # Create the CA.
  mkdir -p $TARGET
  cd $TARGET

  easyrsa --batch init-pki
  easyrsa --batch --dn-mode=cn_only --req-cn="'$NAME'" build-ca $OPTS
}

create_certificate_authority() {

  if [ -n "$1" ]; then
    # Create both a "root" and a "sub" ca.
    echo "Creating root and sub certificate authorities."

    # Create the "root" ca.
    create_ca /root/root-ca  "Root CA"       "nopass"
    easyrsa gen-crl

    # Display the "root" certificate.
    echo "Root CA:"
    openssl x509 -noout -text -in /root/root-ca/pki/ca.crt | grep "CN ="

    # Create the "sub" ca.
    create_ca /root          "Signer #1 CA"  "subca nopass"

    # Get into the "root" ca.
    cd /root/root-ca

    # Import the "sub" ca sign request into the "root" ca.
    easyrsa --batch import-req /root/pki/reqs/ca.req subca1

    # Sign the "sub" ca request.
    easyrsa --batch sign-req ca subca1

    # Get into "sub" (signing) ca.
    cd /root

    # Copy the signed ca certificate from the "root" ca.
    cp -p /root/root-ca/pki/issued/subca1.crt pki/ca.crt

    # Copy the "root" ca certificate and crl.
    cp -p /root/root-ca/pki/ca.crt  pki/root-ca.crt
    cp -p /root/root-ca/pki/crl.pem pki/root-crl.pem

  else
    # Just create a simple ca.
    echo "Creating a standalone certificate authority."
    create_ca /root          "Standalone CA"       "nopass"
  fi

  # Generate the crl for the signing ca.
  easyrsa gen-crl

  # Display the signing certificate.
  echo "Signing CA:"
  openssl x509 -noout -text -in /root/pki/ca.crt | grep "CN ="
}

setup_sshd() {

  # Generate a host key.
  ssh-keygen -t ed25519 -N "" -f /etc/ssh/ssh_host_ed25519_key

  # Create a root access key pair for testing.
  mkdir -p /root/.ssh
  ##ssh-keygen -t ed25519 -N "" -f /etc/openvpn/id_ed25519_testing -C "testing@example.com"
  cp -p /etc/testing/id_ed25519_testing.pub /root/.ssh/authorized_keys

  # Unlock the root account.
  passwd -u root

  # Run the ssh daemon.
  /usr/sbin/sshd -f /etc/ssh/sshd_config

  # Inform the server container that the certificate authority is ready.
  touch /etc/openvpn/ca-is-ready

  # Wait up to 5 minutes for tests to finish.
  for try in $(seq 0 150); do
    sleep 2s
    [ -e /etc/openvpn/stop ] && break
  done
}

# ssh -o IdentitiesOnly=true -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519_testing root@ca.example.com

create_certificate_authority $@
setup_sshd

exit 0

